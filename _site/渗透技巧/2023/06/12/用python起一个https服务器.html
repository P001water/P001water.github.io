<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="Hello, P001's blog!" property="og:site_name">

  <meta content="渗透技巧——用python简单起个https服务器" property="og:title">


  <meta content="article" property="og:type">


  <meta content=" <h1>P001water@c:\Users\maylas\.ssh</h1> <h3>Do Enjoy youself in hack life</h3> --------CMD /c 这里是朴水... ... Reply from 1988 !-------" property="og:description">


  <meta content="http://localhost:4000/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7/2023/06/12/%E7%94%A8python%E8%B5%B7%E4%B8%80%E4%B8%AAhttps%E6%9C%8D%E5%8A%A1%E5%99%A8.html" property="og:url">


  <meta content="2023-06-12T00:00:00+08:00" property="article:published_time">
  <meta content="http://localhost:4000/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="渗透技巧" property="article:section">
  


  

  <title>渗透技巧——用python简单起个https服务器</title>
  <meta name="description" content="  文章首发于用python简单起个https服务器 - 先知社区 (aliyun.com)">
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script> -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  
  <!-- <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'> -->
  <!-- <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'> -->
  <!-- <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'> -->
  <!-- <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous"> -->
  <link rel="canonical" href="http://localhost:4000/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7/2023/06/12/%E7%94%A8python%E8%B5%B7%E4%B8%80%E4%B8%AAhttps%E6%9C%8D%E5%8A%A1%E5%99%A8.html">
  <link rel="alternate" type="application/rss+xml" title="Hello, P001's blog!" href="http://localhost:4000/feed.xml">
</head>


  <body>
<section>
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Hello, P001's blog!</a>
    </div>
    

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        
        <li><a href="/Lnk/">Lnk</a></li>
        
        
        
        <li><a href="/about/">About</a></li>
        
        
        
        
        
        
        
        


      </ul>

    <!--  <ul class="nav navbar-nav navbar-right">
        <li><a href="#">Know More!</a></li>

      </ul>-->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
</section>

<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">渗透技巧——用python简单起个https服务器</h1>
      <p class="post-meta"><time datetime="2023-06-12T00:00:00+08:00" itemprop="datePublished">Jun 12, 2023</time></p>
      
    </div>

</div>


  <div class="post-content container" itemprop="articleBody">
    <blockquote>
  <p>文章首发于<a href="https://xz.aliyun.com/t/12605">用python简单起个https服务器 - 先知社区 (aliyun.com)</a></p>
</blockquote>

<h1 id="前言">前言</h1>

<p>偶然碰见的很有意思的内容</p>

<p>平时我们经常有起个http服务器的需求，一般是 <code class="language-plaintext highlighter-rouge">python -m http.server port</code>，很明显，这样的文件下载时是明文传输的</p>

<p>访问本地起的http服务</p>

<p><img src="/img/image-20230613140607581.png" alt="image-20230613140607581" /></p>

<p>wireshark捕获下，http的内容是直接可见的</p>

<p><img src="/img/image-20230613140735449.png" alt="image-20230613140735449" style="zoom: 67%;" /></p>

<p>这时候考虑加个网站ssl证书把http &gt; https，也就是自签名，反正也是访问我们自己的服务，下面是python代码实现，小改动自，<a href="https://ohyicong.medium.com/how-to-create-a-https-server-with-one-liner-of-code-655e7e28ccd">Yicong – Medium</a></p>

<p>自己可以根据需求改动签名中的信息，比如甩锅啥的</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Python 3
# Usage: python3 SimpleHTTPSServer.py
</span>
<span class="kn">from</span> <span class="n">OpenSSL</span> <span class="kn">import</span> <span class="n">crypto</span><span class="p">,</span> <span class="n">SSL</span>
<span class="kn">from</span> <span class="n">socket</span> <span class="kn">import</span> <span class="n">gethostname</span>
<span class="kn">from</span> <span class="n">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">gmtime</span><span class="p">,</span> <span class="n">mktime</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">http.server</span><span class="p">,</span> <span class="n">ssl</span>
<span class="kn">import</span> <span class="n">argparse</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"SimpleHTTPSServer </span><span class="se">\n</span><span class="s"> Usage: python3 SimpleHTTPSServer.py 443"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="s">"port"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">443</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">"?"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Port Number, default is 443"</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>
<span class="n">CERT_PATH</span> <span class="o">=</span> <span class="s">"server.crt"</span>
<span class="n">KEY_PATH</span> <span class="o">=</span> <span class="s">"server.key"</span>
<span class="n">PEM_PATH</span> <span class="o">=</span> <span class="s">"server.pem"</span>

<span class="k">def</span> <span class="nf">create_self_signed_cert</span><span class="p">(</span><span class="n">cert_path</span><span class="p">,</span><span class="n">key_path</span><span class="p">,</span><span class="n">pem_path</span><span class="p">):</span>
    <span class="c1"># create a key pair
</span>    <span class="n">k</span> <span class="o">=</span> <span class="n">crypto</span><span class="p">.</span><span class="nc">PKey</span><span class="p">()</span>
    <span class="n">k</span><span class="p">.</span><span class="nf">generate_key</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">TYPE_RSA</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>

    <span class="c1"># create a self-signed cert
</span>    <span class="n">cert</span> <span class="o">=</span> <span class="n">crypto</span><span class="p">.</span><span class="nc">X509</span><span class="p">()</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">get_subject</span><span class="p">().</span><span class="n">C</span> <span class="o">=</span> <span class="s">"UK"</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">get_subject</span><span class="p">().</span><span class="n">ST</span> <span class="o">=</span> <span class="s">"London"</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">get_subject</span><span class="p">().</span><span class="n">L</span> <span class="o">=</span> <span class="s">"London"</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">get_subject</span><span class="p">().</span><span class="n">O</span> <span class="o">=</span> <span class="s">"Dummy Company Ltd"</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">get_subject</span><span class="p">().</span><span class="n">OU</span> <span class="o">=</span> <span class="s">"Dummy Company Ltd"</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">get_subject</span><span class="p">().</span><span class="n">CN</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">gethostname</span><span class="p">()</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">set_serial_number</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">gmtime_adj_notBefore</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">gmtime_adj_notAfter</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mi">365</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">set_issuer</span><span class="p">(</span><span class="n">cert</span><span class="p">.</span><span class="nf">get_subject</span><span class="p">())</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">set_pubkey</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">cert</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">'sha1'</span><span class="p">)</span>
    <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cert_path</span><span class="p">)):</span>
        <span class="nf">open</span><span class="p">(</span><span class="n">cert_path</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="nf">dump_certificate</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cert</span><span class="p">))</span>
    <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">key_path</span><span class="p">)):</span>
        <span class="nf">open</span><span class="p">(</span><span class="n">key_path</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="nf">dump_privatekey</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
    <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">pem_path</span><span class="p">)):</span>
        <span class="nf">open</span><span class="p">(</span><span class="n">pem_path</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="nf">dump_privatekey</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="nf">open</span><span class="p">(</span><span class="n">pem_path</span><span class="p">,</span> <span class="s">"ab"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="nf">dump_certificate</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">cert</span><span class="p">))</span>
    
<span class="k">def</span> <span class="nf">create_https_server</span><span class="p">(</span><span class="n">cert_path</span><span class="p">,</span><span class="n">key_path</span><span class="p">,</span><span class="n">port</span><span class="p">):</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">httpd</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="nc">HTTPServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">)</span>
        <span class="n">httpd</span><span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl</span><span class="p">.</span><span class="nf">wrap_socket</span><span class="p">(</span><span class="n">httpd</span><span class="p">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="s">'server.pem'</span><span class="p">,</span> <span class="n">ssl_version</span><span class="o">=</span><span class="n">ssl</span><span class="p">.</span><span class="n">PROTOCOL_TLS</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nf">exit</span><span class="p">(</span><span class="s">"[ERR] Port %d has been taken."</span><span class="o">%</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Serving HTTPS on 0.0.0.0 port %d..."</span><span class="o">%</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
    <span class="n">httpd</span><span class="p">.</span><span class="nf">serve_forever</span><span class="p">()</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="nf">create_self_signed_cert</span><span class="p">(</span><span class="n">CERT_PATH</span><span class="p">,</span><span class="n">KEY_PATH</span><span class="p">,</span><span class="n">PEM_PATH</span><span class="p">)</span>
    <span class="nf">create_https_server</span><span class="p">(</span><span class="n">CERT_PATH</span><span class="p">,</span><span class="n">KEY_PATH</span><span class="p">,</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="p">)</span>
</code></pre></div></div>

<p>用上面的代码起个https服务，同样访问文件，因为是自签名的，所以用浏览器访问依然会被浏览器标记为不信任，还是显示为http</p>

<p><img src="/img/image-20230613145420949.png" alt="image-20230613145420949" /></p>

<p><img src="/img/image-20230613141549693.png" alt="image-20230613141549693" style="zoom: 80%;" /></p>

<p>但是用wireshark抓包看，流量都已被加密了</p>

<p><img src="/img/image-20230613141909325.png" alt="image-20230613141909325" style="zoom: 67%;" /></p>

<p>有的时候我们会放些敏感文件托管在服务器上，直接起个http的在服务器上，很容易几天就被标成恶意ip了。可能就是因为明文传输过程中敏感文件中的特征引起的，这种起个自签名的https服务，流量是被加密过的，对IDS在流量层面的检测应该也有点作用</p>

<h1 id="download-file">Download file</h1>

<p>由于是自签名的，下载文件时需要忽略证书检查，否则下载不成功</p>

<p><img src="/img/image-20230613134029212.png" alt="image-20230613134029212" /></p>

<p>比如wget</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget --no-check-certificate https://192.168.110.1:9999/demo.py
</code></pre></div></div>

<p><img src="/img/image-20230613144331303.png" alt="image-20230613144331303" /></p>

  </div>

</article>

</section>
<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">
    Happy with <i class ="fa fa-heart"></i> by P001water<br>
    Powered By May1as 
  </div>
</nav>

  </body>

</html>
